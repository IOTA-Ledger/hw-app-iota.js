function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=e(require("struct")),t=e(require("iota.lib.js/lib/crypto/bundle/bundle")),n=require("iota.lib.js/lib/utils/utils"),i=e(require("bip32-path")),o=e(require("semver")),a=require("iota.lib.js/lib/utils/inputValidator");const s=function(){function e(){}return e.prototype.then=function(r,t){const n=new e,i=this.s;if(i){const e=1&i?r:t;if(e){try{u(n,1,e(this.v))}catch(e){u(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?u(n,1,r?r(i):i):t?u(n,1,t(i)):u(n,2,i)}catch(e){u(n,2,e)}},n},e}();function u(e,r,t){if(!e.s){if(t instanceof s){if(!t.s)return void(t.o=u.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(u.bind(null,e,r),u.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}function d(e){return e instanceof s&&1&e.s}const c="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function f(e,r,t){for(var n;;){var i=e();if(d(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=t();if(o&&o.then){if(!d(o)){n=1;break}o=o.s}if(r){var a=r();if(a&&a.then&&!d(a)){n=2;break}}}var c=new s,f=u.bind(null,c,2);return(0===n?i.then(h):1===n?o.then(l):a.then(p)).then(void 0,f),c;function l(n){o=n;do{if(r&&(a=r())&&a.then&&!d(a))return void a.then(p).then(void 0,f);if(!(i=e())||d(i)&&!i.v)return void u(c,1,o);if(i.then)return void i.then(h).then(void 0,f);d(o=t())&&(o=o.v)}while(!o||!o.then);o.then(l).then(void 0,f)}function h(e){e?(o=t())&&o.then?o.then(l).then(void 0,f):l(o):u(c,1,o)}function p(){(i=e())?i.then?i.then(h).then(void 0,f):h(i):u(c,1,o)}}function l(e){return e instanceof Array}function h(e){return Number.isInteger(e)&&e>=0}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var p="<0.5",v="9".repeat(27),m=function(e){this.transport=e,this.config=void 0,this.security=0,this.pathArray=void 0,e.decorateAppAPIMethods(this,["setActiveSeed","getAddress","prepareTransfers","getAppVersion","getAppMaxBundleSize"],"IOT")};m.prototype.setActiveSeed=function(e,r){void 0===r&&(r=2);try{var t=this;function n(e){t.config=e;var r=o.satisfies(t.config.app_version,p)?(t._createPubkeyInput=t._createPubkeyInputLegacy,t._createTxInput=t._createTxInputLegacy,Promise.resolve(t._setSeed()).then(function(){})):Promise.resolve(t._reset(!0)).then(function(){});if(r&&r.then)return r.then(function(){})}if(!i.validateString(e))throw new Error("Invalid BIP32 path string");var a=i.fromString(e).toPathArray();if(!a||a.length<2||a.length>5)throw new Error("Invalid BIP32 path length");if(!function(e){return Number.isInteger(e)&&e>=1&&e<=3}(r))throw new Error("Invalid security level provided");return t.pathArray=a,t.security=r,t.config?n(t.config):Promise.resolve(t._getAppConfig()).then(n)}catch(e){return Promise.reject(e)}},m.prototype.getAddress=function(e,r){void 0===r&&(r={});try{if(!this.security)throw new Error("Seed not yet initalized");if(!h(e))throw new Error("Invalid Index provided");return r.checksum=r.checksum||!1,r.display=r.display||!1,Promise.resolve(this._publicKey(e,r.display)).then(function(e){return r.checksum?n.addChecksum(e):e})}catch(e){return Promise.reject(e)}},m.prototype.prepareTransfers=function(e,r,t,n){void 0===n&&(n=function(){return Date.now()});try{var i=this;if(!i.security)throw new Error("Seed not yet initalized");if(!function(e){if(!l(e))return!1;for(var r=0,t=e;r<t.length;r+=1){var n=t[r];if(!a.isAddress(n.address))return!1;if(!Number.isInteger(n.value)||n.value<0)return!1;if(!a.isTrytes(n.tag,"0,27"))return!1}return!0}(e))throw new Error("Invalid transfers array provided");if(!function(e){if(!l(e))return!1;for(var r=0,t=e;r<t.length;r+=1){var n=t[r];if(!a.isAddress(n.address))return!1;if(!Number.isInteger(n.balance)||n.balance<0)return!1;if(!h(n.keyIndex))return!1}return!0}(r))throw new Error("Invalid inputs array provided");if((r=r.filter(function(e){return e.balance>0})).length<1)throw new Error("At least one input required");if(e.length>1)throw new Error("Unsupported number of transfers");var o=r.reduce(function(e,r){return e+r.balance},0),s=e.reduce(function(e,r){return e+r.value},0);if(o===s)t=void 0;else if(!t)throw new Error("Remainder object required");if(t){if(!function(e){return null!==(r=e)&&"object"==typeof r&&!!a.isAddress(e.address)&&!!h(e.keyIndex);var r}(t))throw new Error("Invalid remainder object provided");t={address:t.address,value:o-s,keyIndex:t.keyIndex}}return Promise.resolve(i._prepareTransfers(e,r,t,n)).then(function(e){return Promise.resolve(i._reset(!0)).then(function(){return e})})}catch(e){return Promise.reject(e)}},m.prototype.getAppVersion=function(){try{var e=this;return Promise.resolve(e._getAppConfig()).then(function(r){return e.config=r,r.app_version})}catch(e){return Promise.reject(e)}},m.prototype.getAppMaxBundleSize=function(){try{var e=this;return Promise.resolve(e._getAppConfig()).then(function(r){return e.config=r,r.app_max_bundle_size?r.app_max_bundle_size:8})}catch(e){return Promise.reject(e)}},m.prototype._addSeedFields=function(e){return e.word8("security").word32Ule("pathLength").array("pathArray",this.pathArray.length,"word32Ule")},m.prototype._initSeedFields=function(e){var r=e.fields;r.security=this.security,r.pathLength=this.pathArray.length,r.pathArray=this.pathArray},m.prototype._setSeed=function(){try{var e=new r;return this._addSeedFields(e),e.allocate(),this._initSeedFields(e),Promise.resolve(this._sendCommand(1,0,0,e.buffer(),1e4)).then(function(){})}catch(e){return Promise.reject(e)}},m.prototype._createPubkeyInputLegacy=function(e){var t=new r;return(t=t.word32Ule("index")).allocate(),t.fields.index=e,t},m.prototype._createPubkeyInput=function(e){var t=new r;return this._addSeedFields(t),(t=t.word32Ule("index")).allocate(),this._initSeedFields(t),t.fields.index=e,t},m.prototype._publicKey=function(e,t){try{var n=this._createPubkeyInput(e);return Promise.resolve(this._sendCommand(2,t?1:0,0,n.buffer(),1e4)).then(function(e){var t=(new r).chars("address",81);return t.setBuffer(e),t.fields.address})}catch(e){return Promise.reject(e)}},m.prototype._sign=function(e,t){try{var n=(new r).word32Ule("index");return n.allocate(),n.fields.index=e,Promise.resolve(this._sendCommand(4,0,0,n.buffer(),1e4)).then(function(e){var n=(new r).chars("signature",t).word8Sle("fragmentsRemaining");return n.setBuffer(e),{signature:n.fields.signature,fragmentsRemaining:n.fields.fragmentsRemaining}})}catch(e){return Promise.reject(e)}},m.prototype._createTxInputLegacy=function(e,t,n,i,o,a,s){var u=new r;(u=u.chars("address",81).word32Ule("address_idx").word64Sle("value").chars("tag",27).word32Ule("tx_idx").word32Ule("tx_len").word32Ule("time")).allocate();var d=u.fields;return d.address=e,d.address_idx=t,d.value=n,d.tag=i,d.tx_idx=o,d.tx_len=a,d.time=s,u},m.prototype._createTxInput=function(e,t,n,i,o,a,s){var u=new r;0==o&&this._addSeedFields(u),(u=u.chars("address",81).word32Ule("address_idx").word64Sle("value").chars("tag",27).word32Ule("tx_idx").word32Ule("tx_len").word32Ule("time")).allocate(),0==o&&this._initSeedFields(u);var d=u.fields;return d.address=e,d.address_idx=t,d.value=n,d.tag=i,d.tx_idx=o,d.tx_len=a,d.time=s,u},m.prototype._transaction=function(e,t,n,i,o,a,s){try{var u=this._createTxInput(e,t,n,i,o,a,s),d=1e4;return o==a&&(d=15e4),Promise.resolve(this._sendCommand(3,0==o?0:128,0,u.buffer(),d)).then(function(e){var t=(new r).word8("finalized").chars("bundleHash",81);return t.setBuffer(e),{finalized:t.fields.finalized,bundleHash:t.fields.bundleHash}})}catch(e){return Promise.reject(e)}},m.prototype._getSignatureFragments=function(e,r){try{var t=this;function n(e){return o.match(/.{2187}/g)}var i=2187*t.security/r,o="",a=1,s=f(function(){return a<=i},function(){return a++},function(){return Promise.resolve(t._sign(e,r)).then(function(e){if(o+=e.signature,a===i!=(0===e.fragmentsRemaining))throw new Error("Wrong signture length")})});return s&&s.then?s.then(n):n()}catch(e){return Promise.reject(e)}},m.prototype._addSignatureFragmentsToBundle=function(e){try{var r=!1,t=this,n=0;return f(function(){return!r&&n<e.bundle.length},function(){return n++},function(){var i=e.bundle[n];if(!(i.value>=0))return Promise.resolve(t._getSignatureFragments(n,243)).then(function(o){i.signatureMessageFragment=o.shift();for(var a=i.address,s=1;s<t.security;s++){if(++n>=e.bundle.length)return void(r=!0);var u=e.bundle[n];u.address===a&&0===u.value&&(u.signatureMessageFragment=o.shift())}})})}catch(e){return Promise.reject(e)}},m.prototype._signBundle=function(e,r){try{var t=this;function n(){if(!i)throw new Error("Bundle not finalized");if(o!==e.bundle[0].bundle)throw new Error("Wrong bundle hash");return Promise.resolve(t._addSignatureFragmentsToBundle(e)).then(function(){})}var i=!1,o="",a=function(e,r,t){if("function"==typeof e[c]){var n,i,o,a=e[c]();if(function e(t){try{for(;!(n=a.next()).done;)if((t=r(n.value))&&t.then){if(!d(t))return void t.then(e,o||(o=u.bind(null,i=new s,2)));t=t.v}i?u(i,1,t):i=t}catch(e){u(i||(i=new s),2,e)}}(),a.return){var f=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(f,function(e){throw f(e)});f()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var l=[],h=0;h<e.length;h++)l.push(e[h]);return function(e,r,t){var n,i,o=-1;return function t(a){try{for(;++o<e.length;)if((a=r(o))&&a.then){if(!d(a))return void a.then(t,i||(i=u.bind(null,n=new s,2)));a=a.v}n?u(n,1,a):n=a}catch(e){u(n||(n=new s),2,e)}}(),n}(l,function(e){return r(l[e])})}(e.bundle,function(e){return Promise.resolve(t._transaction(e.address,r[e.address]?r[e.address]:0,e.value,e.obsoleteTag,e.currentIndex,e.lastIndex,e.timestamp)).then(function(e){i=e.finalized,o=e.bundleHash})});return a&&a.then?a.then(n):n()}catch(e){return Promise.reject(e)}},m.prototype._hasDuplicateAddresses=function(e,r,t){var n=new Set;return e.forEach(function(e){return n.add(e.address)}),r.forEach(function(e){return n.add(e.address)}),!(!t||!n.has(t.address))||n.length===e.length+r.length},m.prototype._prepareTransfers=function(e,r,i,o){try{var a=this;if(e=e.map(function(e){return Object.assign({},e,{address:n.noChecksum(e.address),tag:e.tag?e.tag.padEnd(27,"9"):v})}),r=r.map(function(e){return Object.assign({},e,{address:n.noChecksum(e.address),security:a.security})}),i&&(i=Object.assign({},i,{address:n.noChecksum(i.address)})),a._hasDuplicateAddresses(e,r,i))throw new Error("transaction must not contain duplicate addresses");var s=Math.floor(o()/1e3),u=new t;e.forEach(function(e){return u.addEntry(1,e.address,e.value,e.tag,s,-1)}),r.forEach(function(e){return u.addEntry(e.security,e.address,-e.balance,v,s,e.keyIndex)}),i&&u.addEntry(1,i.address,i.value,v,s,i.keyIndex),u.addTrytes([]),u.finalize();var d={};return r.forEach(function(e){return d[e.address]=e.keyIndex}),i&&(d[i.address]=i.keyIndex),Promise.resolve(a._signBundle(u,d)).then(function(){var e=[];return u.bundle.forEach(function(r){return e.push(n.transactionTrytes(r))}),e.reverse()})}catch(e){return Promise.reject(e)}},m.prototype._createAppConfigOutputLegacy=function(){return(new r).word8("app_flags").word8("app_version_major").word8("app_version_minor").word8("app_version_patch")},m.prototype._createAppConfigOutput=function(){return(new r).word8("app_version_major").word8("app_version_minor").word8("app_version_patch").word8("app_max_bundle_size").word8("app_flags")},m.prototype._getAppConfig=function(){try{var e=this;return Promise.resolve(e._sendCommand(16,0,0,void 0,1e4)).then(function(r){var t=e._createAppConfigOutput();r.length<t.length()+2&&(t=e._createAppConfigOutputLegacy()),t.setBuffer(r);var n=t.fields;return{app_max_bundle_size:n.app_max_bundle_size,app_flags:n.app_flags,app_version:n.app_version_major+"."+n.app_version_minor+"."+n.app_version_patch}})}catch(e){return Promise.reject(e)}},m.prototype._reset=function(e){void 0===e&&(e=!1);try{return Promise.resolve(this._sendCommand(255,e?1:0,0,void 0,1e4)).then(function(){})}catch(e){return Promise.reject(e)}},m.prototype._sendCommand=function(e,r,t,n,i){try{var o=this.transport;return function(a,s){try{var u=(o.setExchangeTimeout(i),Promise.resolve(o.send(122,e,r,t,n)))}catch(e){return s(e)}return u&&u.then?u.then(void 0,s):u}(0,function(e){var r=function(e){if("U2F_5"==e.id)return"Ledger device timeout. Ensure Ledger is plugged in and IOTA app is running";switch(e.statusCode){case 36864:return"Success";case 26368:return"Incorrect input length";case 27264:return"Incorrect data";case 27392:return"Incorrect command parameter";case 27648:return"Incorrect length specified in header";case 27904:return"Invalid INS command";case 28160:return"Incorrect CLA (Wrong application opened)";case 26880:return"Command not allowed (Command out of order)";case 27010:return"Security not satisfied (Device locked)";case 27013:return"Condition of use not satisfied (Denied by the user)";case 25601:return"Security not satisfied (Timeout exceeded)";case 27041:return"Bundle error (Insecure hash)";case 27042:return"Bundle error (Non zero balance)";case 27043:return"Bundle error (Invalid meta transaction)";case 27044:return"Bundle error (Invalid input address/index pair(s))";case 27045:return"Bundle error (Address reused)";case 27012:return"Invalid input data";case 27014:return"App has not been initialized by user";case 27025:return"Invalid transaction index";case 27026:return"Invalid transaction order (Output, Inputs, Change)";case 27027:return"Invalid meta transaction";case 27028:return"Invalid output transaction (Output must come first)";default:return e.message}}(e);if(e.message="Ledger device: "+r,e.statusCode){var t=e.statusCode.toString(16);e.message+=" (0x"+t+")"}throw e})}catch(e){return Promise.reject(e)}},module.exports=m;
//# sourceMappingURL=iota.js.map
