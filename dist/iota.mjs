import e from"struct";import r from"iota.lib.js/lib/crypto/bundle/bundle";import{addChecksum as t,noChecksum as n,transactionTrytes as i}from"iota.lib.js/lib/utils/utils";import o from"bip32-path";import a from"semver";import{isAddress as s,isTrytes as u}from"iota.lib.js/lib/utils/inputValidator";const d=function(){function e(){}return e.prototype.then=function(r,t){const n=new e,i=this.s;if(i){const e=1&i?r:t;if(e){try{c(n,1,e(this.v))}catch(e){c(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?c(n,1,r?r(i):i):t?c(n,1,t(i)):c(n,2,i)}catch(e){c(n,2,e)}},n},e}();function c(e,r,t){if(!e.s){if(t instanceof d){if(!t.s)return void(t.o=c.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(c.bind(null,e,r),c.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}function f(e){return e instanceof d&&1&e.s}const l="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function h(e,r,t){for(var n;;){var i=e();if(f(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=t();if(o&&o.then){if(!f(o)){n=1;break}o=o.s}if(r){var a=r();if(a&&a.then&&!f(a)){n=2;break}}}var s=new d,u=c.bind(null,s,2);return(0===n?i.then(h):1===n?o.then(l):a.then(p)).then(void 0,u),s;function l(n){o=n;do{if(r&&(a=r())&&a.then&&!f(a))return void a.then(p).then(void 0,u);if(!(i=e())||f(i)&&!i.v)return void c(s,1,o);if(i.then)return void i.then(h).then(void 0,u);f(o=t())&&(o=o.v)}while(!o||!o.then);o.then(l).then(void 0,u)}function h(e){e?(o=t())&&o.then?o.then(l).then(void 0,u):l(o):c(s,1,o)}function p(){(i=e())?i.then?i.then(h).then(void 0,u):h(i):c(s,1,o)}}function p(e){return e instanceof Array}function v(e){return Number.isInteger(e)&&e>=0}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var m="<0.5",g="9".repeat(27),y=function(e){this.transport=e,this.config=void 0,this.security=0,this.pathArray=void 0,e.decorateAppAPIMethods(this,["setActiveSeed","getAddress","prepareTransfers","getAppVersion","getAppMaxBundleSize"],"IOT")};y.prototype.setActiveSeed=function(e,r){void 0===r&&(r=2);try{var t=this;function n(e){t.config=e;var r=a.satisfies(t.config.app_version,m)?(t._createPubkeyInput=t._createPubkeyInputLegacy,t._createTxInput=t._createTxInputLegacy,Promise.resolve(t._setSeed()).then(function(){})):Promise.resolve(t._reset(!0)).then(function(){});if(r&&r.then)return r.then(function(){})}if(!o.validateString(e))throw new Error("Invalid BIP32 path string");var i=o.fromString(e).toPathArray();if(!i||i.length<2||i.length>5)throw new Error("Invalid BIP32 path length");if(!function(e){return Number.isInteger(e)&&e>=1&&e<=3}(r))throw new Error("Invalid security level provided");return t.pathArray=i,t.security=r,t.config?n(t.config):Promise.resolve(t._getAppConfig()).then(n)}catch(e){return Promise.reject(e)}},y.prototype.getAddress=function(e,r){void 0===r&&(r={});try{if(!this.security)throw new Error("Seed not yet initalized");if(!v(e))throw new Error("Invalid Index provided");return r.checksum=r.checksum||!1,r.display=r.display||!1,Promise.resolve(this._publicKey(e,r.display)).then(function(e){return r.checksum?t(e):e})}catch(e){return Promise.reject(e)}},y.prototype.prepareTransfers=function(e,r,t,n){void 0===n&&(n=function(){return Date.now()});try{var i=this;if(!i.security)throw new Error("Seed not yet initalized");if(!function(e){if(!p(e))return!1;for(var r=0,t=e;r<t.length;r+=1){var n=t[r];if(!s(n.address))return!1;if(!Number.isInteger(n.value)||n.value<0)return!1;if(!u(n.tag,"0,27"))return!1}return!0}(e))throw new Error("Invalid transfers array provided");if(!function(e){if(!p(e))return!1;for(var r=0,t=e;r<t.length;r+=1){var n=t[r];if(!s(n.address))return!1;if(!Number.isInteger(n.balance)||n.balance<0)return!1;if(!v(n.keyIndex))return!1}return!0}(r))throw new Error("Invalid inputs array provided");if((r=r.filter(function(e){return e.balance>0})).length<1)throw new Error("At least one input required");if(e.length>1)throw new Error("Unsupported number of transfers");var o=r.reduce(function(e,r){return e+r.balance},0),a=e.reduce(function(e,r){return e+r.value},0);if(o===a)t=void 0;else if(!t)throw new Error("Remainder object required");if(t){if(!function(e){return null!==(r=e)&&"object"==typeof r&&!!s(e.address)&&!!v(e.keyIndex);var r}(t))throw new Error("Invalid remainder object provided");t={address:t.address,value:o-a,keyIndex:t.keyIndex}}return Promise.resolve(i._prepareTransfers(e,r,t,n)).then(function(e){return Promise.resolve(i._reset(!0)).then(function(){return e})})}catch(e){return Promise.reject(e)}},y.prototype.getAppVersion=function(){try{var e=this;return Promise.resolve(e._getAppConfig()).then(function(r){return e.config=r,r.app_version})}catch(e){return Promise.reject(e)}},y.prototype.getAppMaxBundleSize=function(){try{var e=this;return Promise.resolve(e._getAppConfig()).then(function(r){return e.config=r,r.app_max_bundle_size?r.app_max_bundle_size:8})}catch(e){return Promise.reject(e)}},y.prototype._addSeedFields=function(e){return e.word8("security").word32Ule("pathLength").array("pathArray",this.pathArray.length,"word32Ule")},y.prototype._initSeedFields=function(e){var r=e.fields;r.security=this.security,r.pathLength=this.pathArray.length,r.pathArray=this.pathArray},y.prototype._setSeed=function(){try{var r=new e;return this._addSeedFields(r),r.allocate(),this._initSeedFields(r),Promise.resolve(this._sendCommand(1,0,0,r.buffer(),1e4)).then(function(){})}catch(e){return Promise.reject(e)}},y.prototype._createPubkeyInputLegacy=function(r){var t=new e;return(t=t.word32Ule("index")).allocate(),t.fields.index=r,t},y.prototype._createPubkeyInput=function(r){var t=new e;return this._addSeedFields(t),(t=t.word32Ule("index")).allocate(),this._initSeedFields(t),t.fields.index=r,t},y.prototype._publicKey=function(r,t){try{var n=this._createPubkeyInput(r);return Promise.resolve(this._sendCommand(2,t?1:0,0,n.buffer(),1e4)).then(function(r){var t=(new e).chars("address",81);return t.setBuffer(r),t.fields.address})}catch(e){return Promise.reject(e)}},y.prototype._sign=function(r,t){try{var n=(new e).word32Ule("index");return n.allocate(),n.fields.index=r,Promise.resolve(this._sendCommand(4,0,0,n.buffer(),1e4)).then(function(r){var n=(new e).chars("signature",t).word8Sle("fragmentsRemaining");return n.setBuffer(r),{signature:n.fields.signature,fragmentsRemaining:n.fields.fragmentsRemaining}})}catch(e){return Promise.reject(e)}},y.prototype._createTxInputLegacy=function(r,t,n,i,o,a,s){var u=new e;(u=u.chars("address",81).word32Ule("address_idx").word64Sle("value").chars("tag",27).word32Ule("tx_idx").word32Ule("tx_len").word32Ule("time")).allocate();var d=u.fields;return d.address=r,d.address_idx=t,d.value=n,d.tag=i,d.tx_idx=o,d.tx_len=a,d.time=s,u},y.prototype._createTxInput=function(r,t,n,i,o,a,s){var u=new e;0==o&&this._addSeedFields(u),(u=u.chars("address",81).word32Ule("address_idx").word64Sle("value").chars("tag",27).word32Ule("tx_idx").word32Ule("tx_len").word32Ule("time")).allocate(),0==o&&this._initSeedFields(u);var d=u.fields;return d.address=r,d.address_idx=t,d.value=n,d.tag=i,d.tx_idx=o,d.tx_len=a,d.time=s,u},y.prototype._transaction=function(r,t,n,i,o,a,s){try{var u=this._createTxInput(r,t,n,i,o,a,s),d=1e4;return o==a&&(d=15e4),Promise.resolve(this._sendCommand(3,0==o?0:128,0,u.buffer(),d)).then(function(r){var t=(new e).word8("finalized").chars("bundleHash",81);return t.setBuffer(r),{finalized:t.fields.finalized,bundleHash:t.fields.bundleHash}})}catch(e){return Promise.reject(e)}},y.prototype._getSignatureFragments=function(e,r){try{var t=this;function n(e){return o.match(/.{2187}/g)}var i=2187*t.security/r,o="",a=1,s=h(function(){return a<=i},function(){return a++},function(){return Promise.resolve(t._sign(e,r)).then(function(e){if(o+=e.signature,a===i!=(0===e.fragmentsRemaining))throw new Error("Wrong signture length")})});return s&&s.then?s.then(n):n()}catch(e){return Promise.reject(e)}},y.prototype._addSignatureFragmentsToBundle=function(e){try{var r=!1,t=this,n=0;return h(function(){return!r&&n<e.bundle.length},function(){return n++},function(){var i=e.bundle[n];if(!(i.value>=0))return Promise.resolve(t._getSignatureFragments(n,243)).then(function(o){i.signatureMessageFragment=o.shift();for(var a=i.address,s=1;s<t.security;s++){if(++n>=e.bundle.length)return void(r=!0);var u=e.bundle[n];u.address===a&&0===u.value&&(u.signatureMessageFragment=o.shift())}})})}catch(e){return Promise.reject(e)}},y.prototype._signBundle=function(e,r){try{var t=this;function n(){if(!i)throw new Error("Bundle not finalized");if(o!==e.bundle[0].bundle)throw new Error("Wrong bundle hash");return Promise.resolve(t._addSignatureFragmentsToBundle(e)).then(function(){})}var i=!1,o="",a=function(e,r,t){if("function"==typeof e[l]){var n,i,o,a=e[l]();if(function e(t){try{for(;!(n=a.next()).done;)if((t=r(n.value))&&t.then){if(!f(t))return void t.then(e,o||(o=c.bind(null,i=new d,2)));t=t.v}i?c(i,1,t):i=t}catch(e){c(i||(i=new d),2,e)}}(),a.return){var s=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(s,function(e){throw s(e)});s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],h=0;h<e.length;h++)u.push(e[h]);return function(e,r,t){var n,i,o=-1;return function t(a){try{for(;++o<e.length;)if((a=r(o))&&a.then){if(!f(a))return void a.then(t,i||(i=c.bind(null,n=new d,2)));a=a.v}n?c(n,1,a):n=a}catch(e){c(n||(n=new d),2,e)}}(),n}(u,function(e){return r(u[e])})}(e.bundle,function(e){return Promise.resolve(t._transaction(e.address,r[e.address]?r[e.address]:0,e.value,e.obsoleteTag,e.currentIndex,e.lastIndex,e.timestamp)).then(function(e){i=e.finalized,o=e.bundleHash})});return a&&a.then?a.then(n):n()}catch(e){return Promise.reject(e)}},y.prototype._hasDuplicateAddresses=function(e,r,t){var n=new Set;return e.forEach(function(e){return n.add(e.address)}),r.forEach(function(e){return n.add(e.address)}),!(!t||!n.has(t.address))||n.length===e.length+r.length},y.prototype._prepareTransfers=function(e,t,o,a){try{var s=this;if(e=e.map(function(e){return Object.assign({},e,{address:n(e.address),tag:e.tag?e.tag.padEnd(27,"9"):g})}),t=t.map(function(e){return Object.assign({},e,{address:n(e.address),security:s.security})}),o&&(o=Object.assign({},o,{address:n(o.address)})),s._hasDuplicateAddresses(e,t,o))throw new Error("transaction must not contain duplicate addresses");var u=Math.floor(a()/1e3),d=new r;e.forEach(function(e){return d.addEntry(1,e.address,e.value,e.tag,u,-1)}),t.forEach(function(e){return d.addEntry(e.security,e.address,-e.balance,g,u,e.keyIndex)}),o&&d.addEntry(1,o.address,o.value,g,u,o.keyIndex),d.addTrytes([]),d.finalize();var c={};return t.forEach(function(e){return c[e.address]=e.keyIndex}),o&&(c[o.address]=o.keyIndex),Promise.resolve(s._signBundle(d,c)).then(function(){var e=[];return d.bundle.forEach(function(r){return e.push(i(r))}),e.reverse()})}catch(e){return Promise.reject(e)}},y.prototype._createAppConfigOutputLegacy=function(){return(new e).word8("app_flags").word8("app_version_major").word8("app_version_minor").word8("app_version_patch")},y.prototype._createAppConfigOutput=function(){return(new e).word8("app_version_major").word8("app_version_minor").word8("app_version_patch").word8("app_max_bundle_size").word8("app_flags")},y.prototype._getAppConfig=function(){try{var e=this;return Promise.resolve(e._sendCommand(16,0,0,void 0,1e4)).then(function(r){var t=e._createAppConfigOutput();r.length<t.length()+2&&(t=e._createAppConfigOutputLegacy()),t.setBuffer(r);var n=t.fields;return{app_max_bundle_size:n.app_max_bundle_size,app_flags:n.app_flags,app_version:n.app_version_major+"."+n.app_version_minor+"."+n.app_version_patch}})}catch(e){return Promise.reject(e)}},y.prototype._reset=function(e){void 0===e&&(e=!1);try{return Promise.resolve(this._sendCommand(255,e?1:0,0,void 0,1e4)).then(function(){})}catch(e){return Promise.reject(e)}},y.prototype._sendCommand=function(e,r,t,n,i){try{var o=this.transport;return function(a,s){try{var u=(o.setExchangeTimeout(i),Promise.resolve(o.send(122,e,r,t,n)))}catch(e){return s(e)}return u&&u.then?u.then(void 0,s):u}(0,function(e){var r=function(e){if("U2F_5"==e.id)return"Ledger device timeout. Ensure Ledger is plugged in and IOTA app is running";switch(e.statusCode){case 36864:return"Success";case 26368:return"Incorrect input length";case 27264:return"Incorrect data";case 27392:return"Incorrect command parameter";case 27648:return"Incorrect length specified in header";case 27904:return"Invalid INS command";case 28160:return"Incorrect CLA (Wrong application opened)";case 26880:return"Command not allowed (Command out of order)";case 27010:return"Security not satisfied (Device locked)";case 27013:return"Condition of use not satisfied (Denied by the user)";case 25601:return"Security not satisfied (Timeout exceeded)";case 27041:return"Bundle error (Insecure hash)";case 27042:return"Bundle error (Non zero balance)";case 27043:return"Bundle error (Invalid meta transaction)";case 27044:return"Bundle error (Invalid input address/index pair(s))";case 27045:return"Bundle error (Address reused)";case 27012:return"Invalid input data";case 27014:return"App has not been initialized by user";case 27025:return"Invalid transaction index";case 27026:return"Invalid transaction order (Output, Inputs, Change)";case 27027:return"Invalid meta transaction";case 27028:return"Invalid output transaction (Output must come first)";default:return e.message}}(e);if(e.message="Ledger device: "+r,e.statusCode){var t=e.statusCode.toString(16);e.message+=" (0x"+t+")"}throw e})}catch(e){return Promise.reject(e)}};export default y;
//# sourceMappingURL=iota.mjs.map
